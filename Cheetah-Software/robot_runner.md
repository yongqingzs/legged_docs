# RobotRunner 类分析

本文档旨在深入分析 `Cheetah-Software/robot/include/RobotRunner.h` 和 `RobotRunner.cpp` 文件中的 `RobotRunner` 类，阐述其工作原理、功能及各成员函数的实现。

## 1. RobotRunner 类整体功能概述

`RobotRunner` 类继承自 `PeriodicTask`，是 Cheetah-Software 框架中机器人控制器的通用运行框架。它作为控制代码与硬件/仿真之间的桥梁，提供了一个标准化的接口来初始化、运行和协调机器人控制系统。类的核心功能包括：

- **组件初始化**：构建机器人模型（Mini Cheetah 或 Cheetah 3）、状态估计器、腿控制器和期望状态命令对象。
- **控制循环管理**：在每个控制周期内协调状态估计、控制执行、可视化和数据发布。
- **多机器人支持**：通过条件编译和配置支持不同类型的机器人。
- **安全与鲁棒性**：包括关节位置初始化、紧急停止检查和状态估计器模式切换（正常模式 vs. 作弊模式）。
- **数据通信**：通过 LCM 发布控制命令、状态估计和腿数据，便于调试和监控。
- **任务调度**：作为周期性任务运行，确保控制循环以固定频率执行。

该类是机器人控制系统的核心调度器，确保控制算法与底层硬件的解耦和高效交互。

## 2. 各成员函数的详细功能

### 2.1. 构造函数 `RobotRunner(RobotController* robot_ctrl, PeriodicTaskManager* manager, float period, std::string name)`
- **功能**：初始化 `RobotRunner` 实例，设置控制器、任务管理器、周期和名称。
- **参数**：
  - `robot_ctrl`：指向 `RobotController` 的指针。
  - `manager`：指向 `PeriodicTaskManager` 的指针。
  - `period`：任务运行周期（秒）。
  - `name`：任务名称。
- **操作**：调用父类构造函数添加任务，并初始化 LCM 实例。

### 2.2. `init()` (重写自 `PeriodicTask`)
- **功能**：初始化机器人控制系统的所有组件。
- **操作**：
  - 根据 `robotType` 构建相应的四足机器人对象（Mini Cheetah 或 Cheetah 3）。
  - 初始化浮动基座模型、关节位置初始化器、腿控制器和状态估计器容器。
  - 创建期望状态命令对象。
  - 将所有组件指针传递给 `RobotController`，并调用其 `initializeController()` 方法。
  - 设置 LCM 相关变量为零。

### 2.3. `run()` (重写自 `PeriodicTask`)
- **功能**：执行主控制循环，每个周期调用一次。
- **操作**：
  - 运行状态估计器，清除可视化数据。
  - 调用 `setupStep()` 准备数据。
  - 根据初始化计数器控制腿控制器的启用状态（前几个周期禁用以避免突然运动）。
  - 检查遥控器模式：如果为 0 且启用遥控，则执行紧急停止（清零命令并调用 `Estop()`）。
  - 如果关节位置未初始化，则设置 PD 增益；否则运行用户控制器、更新可视化和位置。
  - 更新可视化数据（关节角度、位置、四元数）。
  - 调用 `finalizeStep()` 发送命令和发布数据。

### 2.4. `setupStep()` (私有方法)
- **功能**：在运行用户代码前准备腿控制器和状态估计器。
- **操作**：
  - 根据机器人类型更新腿数据（SPI 或 TiBoard）。
  - 清零命令、启用控制器、设置最大力矩。
  - 检查并切换状态估计器模式（正常 vs. 作弊模式）。
  - 获取遥控器控制设置。
  - 预留安全和 sanity 检查。

### 2.5. `finalizeStep()` (私有方法)
- **功能**：在用户代码后发送命令并发布调试数据。
- **操作**：
  - 根据机器人类型更新命令（SPI 或 TiBoard）。
  - 设置 LCM 数据并发布到相应主题（腿控制命令、数据、状态估计）。
  - 递增迭代计数器。

### 2.6. `initializeStateEstimator(bool cheaterMode)`
- **功能**：重置状态估计器，支持作弊模式切换。
- **参数**：`cheaterMode`：布尔值，启用作弊模式时使用模拟数据。
- **操作**：
  - 移除所有现有估计器。
  - 添加接触估计器，并设置默认接触相位。
  - 根据模式添加方向和位置/速度估计器（作弊模式使用 `Cheater*`，正常模式使用 `VectorNav*` 和 `LinearKF*`）。

### 2.7. 析构函数 `~RobotRunner()`
- **功能**：清理资源。
- **操作**：删除腿控制器、状态估计器和关节位置初始化器。

### 2.8. `cleanup()` (重写自 `PeriodicTask`)
- **功能**：任务停止时的清理。
- **操作**：目前为空实现，可扩展。

## 3. 补充说明

- **周期性执行**：继承自 `PeriodicTask`，确保控制循环以固定频率运行，提高实时性。
- **机器人类型支持**：通过 `robotType` 枚举区分 Mini Cheetah 和 Cheetah 3，动态选择硬件接口。
- **状态估计器模式**：支持“作弊模式”（使用地面真实数据），用于仿真调试。
- **安全机制**：初始化阶段禁用电机，紧急停止检查防止意外运动。
- **LCM 集成**：发布实时数据，便于外部监控和调试。
- **扩展性**：通过指针传递组件，允许用户控制器自定义逻辑。

这份文档全面地分析了 `RobotRunner` 类的架构和技术细节。
