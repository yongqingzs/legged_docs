### StateEstimator 类整体功能概述

`StateEstimator` 类是一个用于四足机器人（特别是 Unitree GO1 或类似猎豹机器人）的状态估计器。它通过 LCM（Lightweight Communications and Marshalling）协议订阅和处理来自机器人硬件的实时数据，包括 IMU（惯性测量单元）、关节状态、遥控命令和相机图像。类的核心功能是：

- **数据整合与状态估计**：从多个传感器源（如 IMU、关节编码器、力传感器）收集数据，计算机器人身体的线速度、角速度、姿态（RPY）、重力向量、接触状态等关键状态。
- **命令解析**：处理遥控器输入，生成运动命令（如前进、转向、步态切换），支持多种控制模式（高度、侧向速度、步频等）。
- **相机数据处理**：接收和解码多摄像头图像（前、后、左、右、下），用于视觉感知。
- **实时更新**：通过回调函数异步处理 LCM 消息，提供平滑的状态估计（使用历史数据平滑角速度）。
- **接口提供**：为外部模块（如控制算法）提供统一的状态查询接口，支持仿真和真实部署。

该类依赖 LCM 库进行通信，适用于机器人控制系统中的状态反馈环节，确保控制算法获得准确的机器人状态信息。

### 各成员函数的详细功能

#### 1. 构造函数 `__init__(self, lc, use_cameras=True)`
- **功能**：初始化状态估计器实例。
- **参数**：`lc` 为 LCM 实例；`use_cameras` 控制是否订阅相机数据。
- **操作**：
  - 设置关节和接触传感器的索引映射（反转腿部顺序以匹配机器人配置）。
  - 初始化状态变量（如关节位置/速度、线/角速度、姿态矩阵、接触状态等）。
  - 设置平滑历史缓冲区（用于角速度平滑，长度为12）。
  - 订阅 LCM 主题：IMU 数据 (`state_estimator_data`)、关节数据 (`leg_control_data`)、遥控命令 (`rc_command`)。
  - 如果启用相机，则订阅5个摄像头主题（原始和校正图像）。
  - 初始化身体位置和四元数为默认值。

#### 2. 状态获取方法（Getters）
这些方法提供计算后的状态数据，支持外部查询。

- **`get_body_linear_vel(self)`**：计算并返回身体坐标系下的线速度（通过旋转矩阵将世界坐标系速度转换到身体坐标系）。
- **`get_body_angular_vel(self)`**：返回平滑后的身体角速度（使用历史欧拉角变化和时间间隔的平均值，结合平滑比例 `smoothing_ratio`）。
- **`get_gravity_vector(self)`**：返回身体坐标系下的重力向量（通过旋转矩阵将世界重力 [0,0,-1] 转换）。
- **`get_contact_state(self)`**：返回4个足端的接触状态（1表示接触，0表示未接触），按索引重新排序。
- **`get_rpy(self)`**：返回当前的欧拉角（滚转、俯仰、偏航）。
- **`get_command(self)`**：解析遥控器输入，生成运动命令数组（包括前进速度、转向、步频、姿态调整等）。支持模式切换（左摇杆：高度/侧向速度/站姿宽度；右摇杆：步频/足摆高度/俯仰）。根据按钮切换步态（行走、奔跑等）。
- **`get_buttons(self)`**：返回遥控器按钮状态数组。
- **`get_dof_pos(self)`**：返回12个关节的位置（按索引重新排序）。
- **`get_dof_vel(self)`：返回12个关节的速度。
- **`get_tau_est(self)`**：返回12个关节的估计力矩。
- **`get_yaw(self)`**：返回偏航角。
- **`get_body_loc(self)`**：返回身体位置（目前为固定 [0,0,0]，可能用于扩展）。
- **`get_body_quat(self)`**：返回身体四元数（目前为默认 [0,0,0,1]）。
- **`get_camera_*()`**：返回对应摄像头的图像数据（前、后、左、右、下）。

#### 3. LCM 回调函数（Callbacks）
这些函数异步处理接收到的 LCM 消息。

- **`_imu_cb(self, channel, data)`**：处理 IMU 数据消息。解码消息，更新欧拉角、旋转矩阵、接触状态。计算角速度变化历史，用于平滑估计。
- **`_legdata_cb(self, channel, data)`**：处理关节控制数据。解码消息，更新关节位置、速度和力矩估计。记录首次接收时间。
- **`_rc_command_cb(self, channel, data)`**：处理遥控命令。解码消息，更新摇杆位置、按钮状态和模式。检测按钮按下事件（用于模式切换）。
- **`_camera_cb(self, channel, data)`**：处理原始相机图像。解码消息，重塑图像数据（200x464x3），根据摄像头ID存储到对应变量。
- **`_rect_camera_cb(self, channel, data)`**：处理校正相机图像。类似 `_camera_cb`，但处理不同形状的校正图像（116x100x3），并翻转/转置以正确显示。

#### 4. 其他方法
- **`poll(self, cb=None)`**：轮询 LCM 消息的主循环。使用 `select` 监听文件描述符，处理接收到的消息。支持键盘中断退出。
- **`spin(self)`**：启动后台线程运行 `poll` 方法，实现异步消息处理。
- **`close(self)`**：取消关节数据订阅，清理资源。

### 补充说明
- **数据平滑**：类使用历史缓冲区对角速度进行平滑处理，提高估计稳定性。
- **索引映射**：关节和接触索引被重新排序，以匹配机器人硬件配置。
- **扩展性**：支持相机数据，可用于视觉SLAM或避障；遥控命令解析灵活，支持多种步态。
- **使用场景**：在机器人控制循环中调用 getter 方法获取状态，结合 `spin()` 保持实时更新。适用于强化学习或传统控制算法的状态反馈。