# Custom 类分析

本文档旨在深入分析 `walk-these-ways` 项目中 `go1_gym_deploy/unitree_legged_sdk_bin/lcm_position.cpp` 文件中的 `Custom` 类，阐述其工作原理、功能及各成员函数的实现。

## 1. Custom 类整体功能概述

`Custom` 类是一个用于控制 Unitree GO1 四足机器人的底层控制器类。它结合了 UDP（用于与机器人硬件直接通信）和 LCM（用于与高层控制算法通信）协议，实现实时状态反馈和命令执行。类的核心功能包括：

- **UDP 通信**：通过 UDP 套接字与机器人主控板交换数据，包括接收状态信息（关节位置、IMU 数据）和发送控制命令（关节目标位置、PD 增益）。
- **LCM 集成**：订阅高层控制命令（通过 `pd_tau_targets_lcmt` 消息），发布机器人状态（通过 `state_estimator_lcmt`、`leg_control_data_lcmt`、`rc_command_lcmt` 消息），实现与强化学习部署框架的接口。
- **机器人控制**：在控制循环中处理遥控器输入、更新状态、执行安全检查，并生成控制命令。
- **多线程管理**：使用线程处理 LCM 消息，避免阻塞主控制循环。
- **安全机制**：集成位置限制和功率保护，确保机器人安全运行。

该类是机器人控制系统的核心，运行在低级别模式下，直接与硬件交互，同时为高层算法提供接口。

## 2. 各成员函数的详细功能

### 2.1. 构造函数 `Custom(uint8_t level)`
- **功能**：初始化 `Custom` 实例，设置通信级别和 UDP 连接。
- **参数**：`level`：通信级别（通常为 `LOWLEVEL`）。
- **操作**：
  - 初始化 `Safety` 和 `UDP` 对象。
  - 设置 UDP 端口和 IP 地址（本地 8090，机器人 192.168.123.10:8007）。
  - 初始化命令数据结构。

### 2.2. `init()`
- **功能**：初始化 LCM 订阅和线程，设置默认关节命令。
- **操作**：
  - 订阅 "pd_plustau_targets" 主题，绑定 `handleActionLCM` 回调。
  - 启动 LCM 处理线程。
  - 设置默认关节目标位置（名义姿态）和 PD 增益。
  - 初始化标志变量（如 `_firstCommandReceived`）。

### 2.3. `UDPRecv()`
- **功能**：接收 UDP 数据包。
- **操作**：调用 `udp.Recv()` 从机器人获取最新状态数据。

### 2.4. `UDPSend()`
- **功能**：发送 UDP 数据包。
- **操作**：调用 `udp.Send()` 将控制命令发送到机器人。

### 2.5. `RobotControl()`
- **功能**：主控制循环，处理状态更新、命令生成和安全检查。
- **操作**：
  - 获取机器人状态。
  - 处理遥控器输入，更新模式和命令。
  - 发布状态到 LCM（IMU、关节、遥控命令）。
  - 如果是首次运行，设置关节目标为当前位置。
  - 将 LCM 命令应用到 UDP 命令结构。
  - 执行安全检查（位置限制、功率保护）。
  - 设置发送命令。

### 2.6. `handleActionLCM(const lcm::ReceiveBuffer *rbuf, const std::string & chan, const pd_tau_targets_lcmt * msg)`
- **功能**：处理接收到的 LCM 动作命令。
- **参数**：LCM 接收缓冲区、通道名和消息指针。
- **操作**：
  - 复制消息到 `joint_command_simple`。
  - 设置 `_firstCommandReceived` 为 true。

### 2.7. `_simpleLCMThread()`
- **功能**：LCM 消息处理线程。
- **操作**：无限循环调用 `_simpleLCM.handle()` 处理传入消息。

## 3. 补充说明

- **通信架构**：UDP 用于低延迟硬件通信，LCM 用于高层算法接口，实现模块化设计。
- **控制频率**：通过 `LoopFunc` 管理循环频率（`dt = 0.002` 秒，即 500Hz）。
- **安全特性**：`Safety` 类提供位置限制和功率保护，防止关节超限或过载。
- **遥控集成**：解析遥控器按钮和摇杆，映射到控制模式，支持多种操作。
- **初始化策略**：首次运行时将目标位置设置为当前关节位置，避免突然运动。
- **线程安全**：LCM 处理在单独线程中，确保实时性。

这份文档全面地分析了 `Custom` 类的架构和技术细节。
