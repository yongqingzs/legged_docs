# DeploymentRunner 类分析

本文档旨在深入分析 `walk-these-ways` 项目中 `go1_gym_deploy/utils/deployment_runner.py` 文件中的 `DeploymentRunner` 类，阐述其工作原理、功能及各成员函数的实现。

## 1. DeploymentRunner 类整体功能概述

`DeploymentRunner` 类是一个用于将训练好的强化学习策略部署到真实 Unitree GO1 机器人上的运行器类。它管理整个部署流程，包括代理初始化、策略加载、命令处理、日志记录和安全控制。类的核心功能包括：

- **代理管理**：支持添加多个代理（控制代理、开环代理），并管理它们的观测和动作。
- **策略集成**：加载并运行强化学习策略，进行实时推理和动作生成。
- **命令处理**：集成命令配置文件，解析遥控器输入，支持多种控制模式。
- **校准与安全**：提供机器人姿态校准功能，并实现紧急停止机制（基于姿态检测）。
- **日志记录**：实时记录部署过程中的观测、动作、奖励等数据，支持按需保存。
- **控制循环**：运行主控制循环，协调策略推理、动作执行和状态更新。
- **视觉集成**：可选支持视觉服务器，用于相机数据处理。

该类是部署系统的核心，负责从仿真训练到真实世界执行的完整流程，确保安全、高效的机器人控制。

## 2. 各成员函数的详细功能

### 2.1. 构造函数 `__init__(self, experiment_name="unnamed", se=None, log_root=".")`
- **功能**：初始化 `DeploymentRunner` 实例，设置基本配置。
- **参数**：
  - `experiment_name`：实验名称。
  - `se`：状态估计器实例。
  - `log_root`：日志根目录。
- **操作**：
  - 初始化代理字典、策略、命令配置文件和日志器。
  - 设置日志文件名和按钮状态跟踪。
  - 初始化探测和日志标志。

### 2.2. `init_log_filename(self)`
- **功能**：初始化日志文件名，创建唯一的时间戳目录。
- **操作**：
  - 生成基于当前时间的目录路径。
  - 尝试创建目录，避免文件名冲突。
  - 设置日志文件路径。

### 2.3. `add_open_loop_agent(self, agent, name)`
- **功能**：添加开环代理（用于非控制任务）。
- **参数**：`agent`：代理实例；`name`：代理名称。
- **操作**：将代理添加到字典，并注册到日志器。

### 2.4. `add_control_agent(self, agent, name)`
- **功能**：添加控制代理（主控制代理）。
- **参数**：`agent`：代理实例；`name`：代理名称。
- **操作**：设置控制代理名称，将代理添加到字典，并注册到日志器。

### 2.5. `add_vision_server(self, vision_server)`
- **功能**：添加视觉服务器。
- **参数**：`vision_server`：视觉服务器实例。
- **操作**：设置视觉服务器。

### 2.6. `set_command_agents(self, name)`
- **功能**：设置命令代理名称。
- **参数**：`name`：代理名称。
- **操作**：设置命令代理。

### 2.7. `add_policy(self, policy)`
- **功能**：添加强化学习策略。
- **参数**：`policy`：策略实例。
- **操作**：设置策略。

### 2.8. `add_command_profile(self, command_profile)`
- **功能**：添加命令配置文件。
- **参数**：`command_profile`：命令配置文件实例。
- **操作**：设置命令配置文件。

### 2.9. `calibrate(self, wait=True, low=False)`
- **功能**：校准机器人姿态，从当前姿态缓慢移动到名义姿态或低姿态。
- **参数**：
  - `wait`：是否等待用户确认。
  - `low`：是否使用低姿态目标。
- **操作**：
  - 获取当前关节位置。
  - 生成目标序列，逐步移动到最终目标。
  - 执行校准动作，等待用户按键确认。
  - 重置所有代理。

### 2.10. `run(self, num_log_steps=1000000000, max_steps=100000000, logging=True)`
- **功能**：运行主部署循环。
- **参数**：
  - `num_log_steps`：日志步数。
  - `max_steps`：最大步数。
  - `logging`：是否启用日志。
- **操作**：
  - 断言必要组件已设置。
  - 重置代理并校准。
  - 在循环中：
    - 执行策略推理生成动作。
    - 为每个代理执行步进。
    - 检查姿态紧急停止。
    - 处理日志命令（基于遥控器按钮）。
    - 记录数据。
  - 处理键盘中断，保存日志。

## 3. 补充说明

- **多代理支持**：允许同时运行多个代理，便于多机器人或混合控制场景。
- **安全机制**：姿态检测紧急停止和校准功能，确保机器人安全。
- **日志管理**：动态日志文件名生成，支持按需保存和重置。
- **遥控集成**：按钮状态跟踪，支持实时控制模式切换。
- **异常处理**：键盘中断处理，确保日志保存。
- **扩展性**：支持视觉服务器和自定义代理，便于功能扩展。

这份文档全面地分析了 `DeploymentRunner` 类的架构和技术细节。
