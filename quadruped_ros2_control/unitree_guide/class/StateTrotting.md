# StateTrotting 类分析

## 1. 功能

StateTrotting 类是四足机器人控制系统中有限状态机 (FSM) 的一个状态实现，专门负责 trotting（小跑）步态的控制。该类继承自 FSMState，实现了完整的步态控制循环，包括用户命令处理、轨迹规划、力平衡控制和关节伺服控制。

主要功能包括：
- **用户接口**：处理遥控器输入，转换为运动命令
- **运动规划**：计算期望的身体位置、速度和姿态
- **步态生成**：集成 GaitGenerator 生成脚端轨迹
- **力控制**：使用 BalanceCtrl 计算支撑腿的接触力
- **位置控制**：为摆动腿提供 PD 位置控制
- **状态管理**：根据运动需求切换步态状态

该类实现了 trotting 步态的核心控制逻辑，是四足机器人动态运动的基础。

## 2. 各方法实现的功能

### 构造函数
```cpp
StateTrotting(CtrlInterfaces &ctrl_interfaces, CtrlComponent &ctrl_component)
```
- **功能**：初始化 trotting 状态的参数和组件
- **实现**：
  - 设置控制增益 (Kpp, Kdp, kp_w_ 等)
  - 初始化速度和角速度限制
  - 获取控制频率计算时间步长 dt_

### enter 方法 (状态进入)
```cpp
void enter()
```
- **功能**：进入 trotting 状态时的初始化
- **实现**：
  - 设置初始身体位置命令 (pcd_)
  - 重置速度命令和偏航角
  - 初始化旋转矩阵和角速度
  - 重启步态生成器

### run 方法 (主控制循环)
```cpp
void run(const rclcpp::Time &time, const rclcpp::Duration &period)
```
- **功能**：执行 trotting 控制的主循环
- **实现流程**：
  1. 更新机器人状态估计
  2. 获取用户命令并计算控制命令
  3. 设置步态参数并生成脚端轨迹
  4. 计算关节扭矩和位置命令
  5. 根据运动需求更新步态状态
  6. 设置关节增益

### exit 方法 (状态退出)
```cpp
void exit()
```
- **功能**：退出 trotting 状态时的清理
- **实现**：将步态状态设置为 SWING_ALL

### checkChange 方法 (状态转换检查)
```cpp
FSMStateName checkChange()
```
- **功能**：检查是否需要切换到其他状态
- **实现**：根据控制输入命令切换到 PASSIVE 或 FIXEDSTAND 状态

### getUserCmd 方法 (用户命令获取)
```cpp
void getUserCmd()
```
- **功能**：从遥控器输入获取用户命令
- **实现**：
  - 解析左摇杆输入为前进/侧向速度
  - 解析右摇杆输入为偏航角速度
  - 应用低通滤波平滑角速度命令

### calcCmd 方法 (控制命令计算)
```cpp
void calcCmd()
```
- **功能**：将用户命令转换为全局坐标系的控制命令
- **实现**：
  - 坐标系转换：身体坐标系 → 全局坐标系
  - 速度限制和饱和处理
  - 位置积分和限制
  - 偏航角积分和旋转矩阵更新

### calcTau 方法 (扭矩计算)
```cpp
void calcTau()
```
- **功能**：计算关节扭矩命令
- **实现**：
  - **支撑腿**：使用 BalanceCtrl 计算期望力，通过逆动力学转换为扭矩
  - **摆动腿**：使用 PD 控制跟踪期望轨迹
  - 力从全局坐标系转换到身体坐标系
  - 通过 QuadrupedRobot 的逆动力学计算关节扭矩

### calcQQd 方法 (关节位置速度计算)
```cpp
void calcQQd()
```
- **功能**：计算关节空间的位置和速度命令
- **实现**：
  - 将脚端目标从全局坐标系转换到身体坐标系
  - 使用 QuadrupedRobot 的逆运动学计算关节角度和速度
  - 设置关节位置和速度命令接口

### calcGain 方法 (增益计算)
```cpp
void calcGain() const
```
- **功能**：根据腿部状态设置关节 PD 增益
- **实现**：
  - **摆动腿**：高增益 (Kp=3.0, Kd=2.0) 用于精确跟踪
  - **支撑腿**：低增益 (Kp=0.8, Kd=0.8) 用于力控制

### checkStepOrNot 方法 (迈步检查)
```cpp
bool checkStepOrNot()
```
- **功能**：判断是否需要执行动态步态
- **实现**：检查速度命令、位置误差、速度误差和角速度是否超过阈值

## 3. 需要说明的内容

### 控制架构
- **分层控制**：
  - **高层**：用户命令 → 运动规划
  - **中层**：步态生成 → 轨迹规划
  - **底层**：力控制/位置控制 → 关节伺服
- **混合控制**：支撑腿使用力控制，摆动腿使用位置控制

### PD 控制参数
- **位置控制 (Kpp, Kdp)**：身体位置跟踪，增益 [70, 10]
- **姿态控制 (kp_w_, Kd_w_)**：偏航角控制，增益 780 和 [70,70,70]
- **摆动控制 (Kp_swing_, Kd_swing_)**：轨迹跟踪，增益 [400,10]

### 坐标系转换
- **身体坐标系 (Body Frame)**：机器人中心坐标系
- **全局坐标系 (Global Frame)**：世界参考坐标系
- **转换矩阵**：B2G_RotMat (身体→全局), G2B_RotMat (全局→身体)

### 状态变量
- **pcd_**：期望身体位置 (Position Command Desired)
- **vel_target_**：期望身体速度
- **yaw_cmd_**：期望偏航角
- **Rd**：期望旋转矩阵

### 安全限制
- **速度限制**：前进 ±0.4 m/s，侧向 ±0.3 m/s，转向 ±0.5 rad/s
- **加速度限制**：位置 ±3 m/s²，姿态 ±40 rad/s²
- **位置误差限制**：±0.05 m

### 步态状态机
- **WAVE_ALL**：正常 trotting 步态
- **STANCE_ALL**：全支撑状态（静止）
- **SWING_ALL**：全摆动状态（状态切换）

### 依赖组件
- **Estimator**：状态估计
- **QuadrupedRobot**：运动学/动力学模型
- **BalanceCtrl**：平衡力控制
- **WaveGenerator**：步态时序
- **GaitGenerator**：轨迹生成

### 实时性能
- **控制频率**：与系统频率同步
- **计算复杂度**：包含 QP 优化和逆运动学
- **稳定性**：通过增益调度和限制确保系统稳定

### 扩展性
- **参数调优**：增益可通过配置文件调整
- **多步态支持**：可扩展到其他步态状态
- **传感器融合**：可集成更多传感器信息

## 4. 总结

StateTrotting 类实现了四足机器人 trotting 步态的完整控制逻辑，结合了运动规划、力控制和位置控制。该类通过分层架构实现了稳定的动态运动控制，在支撑腿使用基于 QP 的力控制，在摆动腿使用 PD 位置控制，确保了机器人的平衡性和轨迹跟踪精度。在实际应用中，该状态是四足机器人运动控制的核心，适用于各种动态任务场景。