# WaveGenerator 类分析

## 1. 功能

WaveGenerator 类是一个四足机器人步态生成器，用于控制四条腿的协调运动周期。它根据设定的步态参数（周期、支撑比例、相位偏置）生成每条腿的相位 (phase) 和接触状态 (contact)，实现不同步态模式的切换和控制。

该类支持三种主要步态状态：
- **WAVE_ALL**：标准波形步态，四条腿按相位差依次运动
- **SWING_ALL**：全摆动状态，四条腿同时抬起
- **STANCE_ALL**：全支撑状态，四条腿同时着地

WaveGenerator 为四足机器人的步态规划提供基础的时序控制，是高层运动控制器的重要组件。

## 2. 各方法实现的功能

### 构造函数
```cpp
WaveGenerator(const double period, const double st_ratio, const Vec4 &bias)
```
- **功能**：初始化步态生成器参数
- **参数**：
  - period: 步态周期 (秒)
  - st_ratio: 支撑相比例 (0-1之间)
  - bias: 四条腿的相位偏置 [0,1]
- **实现**：
  - 初始化相位和接触状态历史
  - 验证参数范围 (st_ratio ∈ (0,1), bias ∈ [0,1])
  - 记录起始时间戳用于时序计算

### update 方法 (主更新函数)
```cpp
void update()
```
- **功能**：更新当前时刻的相位和接触状态
- **实现流程**：
  1. 计算当前状态下的相位和接触
  2. 检测状态变化并处理切换逻辑
  3. 在状态切换期间保持连续性，避免突变
  4. 更新历史状态用于下次迭代
- **状态切换处理**：使用 switch_status_ 标记正在切换的腿，在切换完成前保持旧状态

### calcWave 方法 (波形计算核心)
```cpp
void calcWave(Vec4 &phase, VecInt4 &contact, const WaveStatus status)
```
- **功能**：根据步态状态计算相位和接触
- **WAVE_ALL 模式**：
  - 计算归一化时间：考虑相位偏置的循环时间
  - 根据支撑比例判断当前是支撑相还是摆动相
  - 相位计算：支撑相内归一化到 [0,1]，摆动相内归一化到 [0,1]
- **SWING_ALL/STANCE_ALL 模式**：
  - 所有腿统一状态，相位设为 0.5（中间值）

### getter 方法
```cpp
double get_t_stance() const  // 返回支撑相时间
double get_t_swing() const   // 返回摆动相时间
double get_t() const         // 返回总周期时间
```
- **功能**：提供步态时间参数的访问接口

## 3. 需要说明的内容

### 步态参数详解
- **period_**：步态周期，决定运动频率
- **st_ratio_**：支撑相比例，影响步态的稳定性和速度
  - st_ratio_ ≈ 0.6-0.8：适用于慢速步态
  - st_ratio_ ≈ 0.5：对称步态
- **bias_**：相位偏置向量，定义四条腿的相对相位
  - 典型 trot 步态：bias = [0, 0.5, 0.5, 0] (对角线腿同步)
  - 典型 walk 步态：bias = [0, 0.25, 0.5, 0.75] (依次跟随)

### 时间和相位计算
- **归一化时间 (normal_t_)**：
  \[
  normal\_t_i = \frac{t_{current} + period \cdot bias_i \mod period}{period}
  \]
- **相位计算**：
  - 支撑相：$phase = \frac{normal\_t}{st\_ratio}$
  - 摆动相：$phase = \frac{normal\_t - st\_ratio}{1 - st\_ratio}$

### 状态枚举 (WaveStatus)
- **WAVE_ALL**：正常步态模式，支持相位偏置
- **SWING_ALL**：过渡状态，所有腿同时摆动
- **STANCE_ALL**：停止状态，所有腿同时支撑

### 状态切换机制
- **平滑切换**：状态变化时不立即切换所有腿，而是逐个腿切换
- **连续性保证**：切换期间保持相位连续，避免控制突变
- **switch_status_**：4维向量，标记每条腿的切换状态 (1=切换中, 0=已完成)

### 时序同步
- **系统时间**：使用 std::chrono 获取微秒级时间戳
- **起始时间**：构造函数记录的基准时间
- **循环时间**：使用 fmod 实现周期性循环

### 坐标系和约定
- **时间起点**：构造函数调用时刻为 t=0
- **相位范围**：[0,1]，0表示相位开始，1表示相位结束
- **接触状态**：1=支撑，0=摆动

### 性能考虑
- **实时性**：计算复杂度低，适合高频控制循环
- **内存占用**：存储历史状态和切换标志
- **数值稳定性**：使用浮点运算，考虑精度问题

### 扩展性
- **多步态支持**：可扩展更多步态模式
- **自适应参数**：可添加速度/地形自适应调节
- **多腿机器人**：可泛化到六足或更多腿的机器人

## 4. 总结

WaveGenerator 类提供了四足机器人步态控制的基础时序框架，通过参数化控制实现不同步态模式的生成。该类设计简洁高效，支持状态平滑切换，保证了运动控制的连续性和稳定性。在实际应用中，WaveGenerator 通常与轨迹规划器和力控制器配合使用，实现完整的四足机器人运动控制系统。